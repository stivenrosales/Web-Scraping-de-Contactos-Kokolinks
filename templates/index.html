<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Extractor de Contactos Web</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(circle at top, #f0f4ff, #f8f9fa 55%);
      min-height: 100vh;
    }
    .card {
      border-radius: 1rem;
    }
    .progress {
      background-color: #e9ecef;
    }
    .progress-bar {
      font-weight: 600;
    }
    .contact-url {
      max-width: 22rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: bottom;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-xl-8">
        <h1 class="fw-bold text-center mb-4">Extractor de Contactos Web</h1>
        <p class="text-center text-muted mb-5">
          Ingresa la URL inicial y deja que el asistente explore el sitio para localizar correos y números de teléfono,
          incluso en subpáginas. Al finalizar podrás descargar los resultados en Excel.
        </p>

        <div id="alert-container"></div>

        <form id="scrape-form" class="card shadow-sm border-0 mb-4">
          <div class="card-body p-4">
            <div class="mb-3">
              <label for="urls-input" class="form-label">URLs de los sitios web</label>
              <textarea id="urls-input" class="form-control" name="urls" rows="4"
                        placeholder="https://ejemplo.com&#10;https://otro-ejemplo.com" required></textarea>
              <div class="form-text">
                Puedes pegar varias direcciones (separadas por salto de línea, coma o punto y coma). Cada sitio se analizará con la misma configuración e incluirá subpáginas internas.
              </div>
            </div>
            <div class="d-flex align-items-center justify-content-between">
              <button type="submit" class="btn btn-primary btn-lg" id="submit-button">
                Iniciar análisis
              </button>
              <div class="text-muted small" id="job-id-label"></div>
            </div>
          </div>
        </form>

        <div id="status-card" class="card shadow-sm border-0 d-none">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0">Seguimiento</h2>
              <span id="status-badge" class="badge bg-secondary">Pendiente</span>
            </div>

            <div class="progress mb-3" style="height: 1.75rem;">
              <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar" style="width: 0%;">0%</div>
            </div>

            <p class="text-muted mb-2" id="progress-label"></p>
            <p class="text-muted mb-3" id="visit-summary" hidden></p>
            <p class="text-muted mb-3" id="current-url-label" hidden></p>

            <ul id="status-errors" class="text-danger small mb-2"></ul>
            <ul id="status-notes" class="text-warning small mb-3"></ul>

            <div id="result-message" class="alert d-none" role="alert"></div>

            <div id="results-section" class="d-none">
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h3 class="h6 mb-0">Resumen por sitio</h3>
                  <span class="badge bg-secondary-subtle text-secondary" id="sites-count">0</span>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Sitio</th>
                        <th scope="col" class="text-center">Estado</th>
                        <th scope="col" class="text-center">Contactos</th>
                      </tr>
                    </thead>
                    <tbody id="sites-body"></tbody>
                  </table>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3" id="contacts-header">
                <h3 class="h6 mb-0">Contactos encontrados</h3>
                <span class="badge bg-primary-subtle text-primary" id="contacts-count">0</span>
              </div>

              <div id="contacts-table" class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col" class="text-center">
                        <input type="checkbox" class="form-check-input" id="select-all-contacts" checked>
                      </th>
                      <th scope="col">Sitio</th>
                      <th scope="col">Tipo</th>
                      <th scope="col">Descripción original</th>
                      <th scope="col">Descripción IA</th>
                      <th scope="col">Dato</th>
                      <th scope="col">Página</th>
                      <th scope="col" class="text-center">Validado</th>
                    </tr>
                  </thead>
                  <tbody id="contacts-body"></tbody>
                </table>
              </div>

              <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mt-3" id="contacts-actions">
                <div class="text-muted small" id="selection-count"></div>
                <button type="button" class="btn btn-success d-none" id="send-button">
                  Enviar a Sheet
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('scrape-form');
    const urlsInput = document.getElementById('urls-input');
    const submitButton = document.getElementById('submit-button');
    const statusCard = document.getElementById('status-card');
    const statusBadge = document.getElementById('status-badge');
    const progressBar = document.getElementById('progress-bar');
    const progressLabel = document.getElementById('progress-label');
    const visitSummary = document.getElementById('visit-summary');
    const currentUrlLabel = document.getElementById('current-url-label');
    const statusErrors = document.getElementById('status-errors');
    const statusNotes = document.getElementById('status-notes');
    const resultMessage = document.getElementById('result-message');
    const resultsSection = document.getElementById('results-section');
    const contactsBody = document.getElementById('contacts-body');
    const contactsCount = document.getElementById('contacts-count');
    const contactsHeader = document.getElementById('contacts-header');
    const sendButton = document.getElementById('send-button');
    const jobIdLabel = document.getElementById('job-id-label');
    const alertContainer = document.getElementById('alert-container');
    const contactsTable = document.getElementById('contacts-table');
    const sitesBody = document.getElementById('sites-body');
    const sitesCount = document.getElementById('sites-count');
    const selectAllCheckbox = document.getElementById('select-all-contacts');
    const selectionCount = document.getElementById('selection-count');
    const contactsActions = document.getElementById('contacts-actions');

    const statusLabels = {
      OK: 'Completado',
      NO_ENCONTRADO: 'Sin datos',
      RESTRINGIDO: 'Restringido',
      ERROR: 'Error',
      PROCESANDO: 'Procesando',
    };

    const statusStyles = {
      OK: 'bg-success',
      NO_ENCONTRADO: 'bg-warning text-dark',
      RESTRINGIDO: 'bg-warning text-dark',
      ERROR: 'bg-danger',
      PROCESANDO: 'bg-info text-dark',
    };

    let currentContacts = [];
    let selectedContactIds = new Set();

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const rawUrls = urlsInput.value.trim();
      if (!rawUrls) {
        showAlert('Debes ingresar al menos una URL válida.', 'danger');
        return;
      }

      disableForm(true);
      resetResults();
      showLoadingState();

      try {
        const response = await fetch('/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls: rawUrls }),
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = payload.error || `No se pudo procesar la solicitud (HTTP ${response.status}).`;
          const detail = payload.details ? ` Detalle: ${payload.details}` : '';
          throw new Error(`${message}${detail}`);
        }
        renderFinalResult(payload);
      } catch (error) {
        statusBadge.className = `badge ${statusStyles.ERROR}`;
        statusBadge.textContent = statusLabels.ERROR;
        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
        progressBar.style.width = '100%';
        progressBar.textContent = 'Error';
        progressLabel.textContent = '';
        showAlert(error.message || 'Ocurrió un error inesperado durante el análisis.', 'danger');
      } finally {
        disableForm(false);
      }
    });

    selectAllCheckbox?.addEventListener('change', (event) => {
      const checked = event.target.checked;
      selectedContactIds = new Set();
      document.querySelectorAll('.contact-select').forEach((checkbox) => {
        checkbox.checked = checked;
        const contactId = checkbox.dataset.contactId;
        if (checked && contactId) {
          selectedContactIds.add(contactId);
        }
      });
      if (!checked) {
        selectedContactIds.clear();
      } else {
        currentContacts.forEach((_, index) => selectedContactIds.add(String(index)));
      }
      updateSelectionSummary();
    });

    sendButton.addEventListener('click', async () => {
      const selected = currentContacts.filter((_, index) => selectedContactIds.has(String(index)));
      if (!selected.length) {
        showAlert('Selecciona al menos un contacto antes de enviar.', 'warning');
        return;
      }
      await sendSelectedContacts(selected);
    });

    function showLoadingState() {
      statusCard.classList.remove('d-none');
      statusBadge.className = `badge ${statusStyles.PROCESANDO}`;
      statusBadge.textContent = statusLabels.PROCESANDO;
      progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
      progressBar.style.width = '100%';
      progressBar.textContent = 'Procesando...';
      progressLabel.textContent = 'Analizando sitios y recopilando contactos, esto puede tardar unos minutos.';
      visitSummary.hidden = true;
      currentUrlLabel.hidden = true;
      resultMessage.classList.add('d-none');
      resultsSection.classList.add('d-none');
    }

    function renderFinalResult(data) {
      const status = data.status || 'ERROR';
      const badgeClasses = statusStyles[status] || 'bg-secondary';
      const statusText = statusLabels[status] || status;
      statusBadge.className = `badge ${badgeClasses}`;
      statusBadge.textContent = statusText;

      progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
      progressBar.style.width = '100%';
      progressBar.textContent = status === 'OK' ? 'Completado' : statusText;
      progressLabel.textContent = data.duration_seconds
        ? `Tiempo total: ${data.duration_seconds} s`
        : '';

      if (data.visited_pages) {
        visitSummary.hidden = false;
        const links = data.explored_links || 0;
        visitSummary.textContent = `Páginas visitadas: ${data.visited_pages} · Enlaces evaluados: ${links}`;
      } else {
        visitSummary.hidden = true;
      }
      currentUrlLabel.hidden = true;
      currentUrlLabel.textContent = '';

      renderErrors(data.errors || []);
      renderNotices(data.notices || []);
      renderSiteResults(data.site_results || []);
      resultsSection.classList.remove('d-none');

      let message = '';
      let variant = 'secondary';
      if (status === 'OK') {
        message = `Se encontraron ${data.contacts_count ?? 0} contactos.`;
        variant = 'success';
      } else if (status === 'NO_ENCONTRADO') {
        message = 'No se localizaron datos de contacto en los sitios analizados.';
        variant = 'warning';
      } else if (status === 'RESTRINGIDO') {
        message = 'Alguno de los sitios parece restringir el acceso automatizado.';
        variant = 'warning';
      } else if (status === 'ERROR') {
        message = 'Ocurrió un error durante el rastreo.';
        variant = 'danger';
      }

      if (message) {
        resultMessage.textContent = message;
        resultMessage.className = `alert alert-${variant}`;
        resultMessage.classList.remove('d-none');
      } else {
        resultMessage.classList.add('d-none');
      }

      const contacts = Array.isArray(data.contacts) ? data.contacts : [];
      currentContacts = contacts.slice();
      contactsBody.innerHTML = '';
      contactsCount.textContent = contacts.length;
      selectedContactIds = new Set();
      contactsTable.classList.toggle('d-none', contacts.length === 0);
      contactsHeader.classList.toggle('d-none', contacts.length === 0);
      contactsActions.classList.toggle('d-none', contacts.length === 0);
      sendButton.classList.toggle('d-none', contacts.length === 0);

      if (contacts.length) {
        renderContacts();
      } else {
        selectionCount.textContent = 'No hay contactos disponibles.';
      }
    }

    function renderContacts() {
      contactsBody.innerHTML = '';
      selectedContactIds = new Set();
      currentContacts.forEach((contact, index) => {
        const id = String(index);
        selectedContactIds.add(id);

        const row = document.createElement('tr');

        const selectCell = document.createElement('td');
        selectCell.className = 'text-center';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input contact-select';
        checkbox.checked = true;
        checkbox.dataset.contactId = id;
        checkbox.addEventListener('change', handleContactToggle);
        selectCell.appendChild(checkbox);
        row.appendChild(selectCell);

        const siteCell = document.createElement('td');
        const sitio = contact.sitio || '';
        if (sitio) {
          const link = document.createElement('a');
          link.href = sitio;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = sitio;
          siteCell.appendChild(link);
        } else {
          siteCell.textContent = sitio;
        }
        row.appendChild(siteCell);

        const tipoCell = document.createElement('td');
        tipoCell.textContent = contact.tipo || '';
        row.appendChild(tipoCell);

        const descCell = document.createElement('td');
        descCell.textContent = contact.descripcion || '';
        row.appendChild(descCell);

        const descIaCell = document.createElement('td');
        descIaCell.textContent = contact.descripcion_enriquecida || '';
        row.appendChild(descIaCell);

        const valorCell = document.createElement('td');
        valorCell.textContent = contact.valor || '';
        if (Array.isArray(contact.flags) && contact.flags.length) {
          valorCell.title = contact.flags.join(', ');
        }
        row.appendChild(valorCell);

        const urlCell = document.createElement('td');
        if (contact.url) {
          const link = document.createElement('a');
          link.href = contact.url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.className = 'contact-url';
          link.textContent = contact.url;
          urlCell.appendChild(link);
        } else {
          urlCell.textContent = '';
        }
        row.appendChild(urlCell);

        const validCell = document.createElement('td');
        validCell.className = 'text-center';
        const validado = contact.validado;
        if (validado === true) {
          validCell.textContent = 'Sí';
          validCell.classList.add('text-success');
        } else if (validado === false) {
          validCell.textContent = 'No';
          validCell.classList.add('text-danger');
        } else {
          validCell.textContent = '';
        }
        if (Array.isArray(contact.flags) && contact.flags.length) {
          validCell.title = contact.flags.join(', ');
        }
        row.appendChild(validCell);

        contactsBody.appendChild(row);
      });
      contactsCount.textContent = currentContacts.length;
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = currentContacts.length > 0;
        selectAllCheckbox.indeterminate = false;
      }
      updateSelectionSummary();
    }

    function handleContactToggle(event) {
      const checkbox = event.target;
      const contactId = checkbox.dataset.contactId;
      if (!contactId) {
        return;
      }
      if (checkbox.checked) {
        selectedContactIds.add(contactId);
      } else {
        selectedContactIds.delete(contactId);
      }
      updateSelectionSummary();
      if (selectAllCheckbox) {
        if (selectedContactIds.size === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (selectedContactIds.size === currentContacts.length) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.indeterminate = true;
        }
      }
    }

    function updateSelectionSummary() {
      const total = currentContacts.length;
      const selected = selectedContactIds.size;
      if (total) {
        selectionCount.textContent = `Seleccionados: ${selected} de ${total}`;
      } else {
        selectionCount.textContent = 'No hay contactos disponibles.';
      }
      sendButton.disabled = selected === 0;
    }

    async function sendSelectedContacts(contacts) {
      try {
        sendButton.disabled = true;
        sendButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enviando...';
        const response = await fetch('/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: null,
            contacts,
            metadata: {
              origin: window.location.origin,
            },
          }),
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          const errorMessage = payload.error || `El servidor respondió con estado ${response.status}.`;
          const detail = payload.details ? ` Detalle: ${payload.details}` : '';
          throw new Error(`${errorMessage}${detail}`);
        }
        if (payload.error) {
          const detail = payload.details ? ` Detalle: ${payload.details}` : '';
          throw new Error(`${payload.error}${detail}`);
        }
        showAlert('Contactos enviados correctamente.', 'success');
      } catch (error) {
        showAlert(error.message || 'No se pudo enviar la información seleccionada.', 'danger');
      } finally {
        sendButton.disabled = false;
        sendButton.textContent = 'Enviar a Sheet';
      }
    }

    function renderSiteResults(sites) {
      sitesBody.innerHTML = '';
      sitesCount.textContent = sites.length;
      if (!Array.isArray(sites) || !sites.length) {
        return;
      }

      sites.forEach((site) => {
        const row = document.createElement('tr');

        const urlCell = document.createElement('td');
        const link = document.createElement('a');
        link.href = site.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = site.url;
        urlCell.appendChild(link);

        const statusCell = document.createElement('td');
        statusCell.className = 'text-center';
        const statusSpan = document.createElement('span');
        const status = site.status || 'NO_ENCONTRADO';
        statusSpan.className = `badge ${statusStyles[status] || 'bg-secondary'}`;
        statusSpan.textContent = statusLabels[status] || status;
        statusCell.appendChild(statusSpan);

        const countCell = document.createElement('td');
        countCell.className = 'text-center';
        countCell.textContent = site.contacts ?? 0;

        row.appendChild(urlCell);
        row.appendChild(statusCell);
        row.appendChild(countCell);
        sitesBody.appendChild(row);
      });
    }

    function renderErrors(errors) {
      statusErrors.innerHTML = '';
      (errors || []).slice(0, 5).forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        statusErrors.appendChild(li);
      });
      statusErrors.hidden = !statusErrors.childElementCount;
    }

    function renderNotices(notices) {
      statusNotes.innerHTML = '';
      (notices || []).slice(0, 5).forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        statusNotes.appendChild(li);
      });
      statusNotes.hidden = !statusNotes.childElementCount;
    }

    function disableForm(disable) {
      submitButton.disabled = disable;
      urlsInput.disabled = disable;
    }

    function resetResults() {
      statusCard.classList.add('d-none');
      resultMessage.classList.add('d-none');
      resultsSection.classList.add('d-none');
      contactsTable.classList.add('d-none');
      contactsHeader.classList.add('d-none');
      contactsActions.classList.add('d-none');
      sendButton.classList.add('d-none');
      statusErrors.innerHTML = '';
      statusErrors.hidden = true;
      statusNotes.innerHTML = '';
      statusNotes.hidden = true;
      contactsBody.innerHTML = '';
      contactsCount.textContent = '0';
      statusBadge.className = 'badge bg-secondary';
      statusBadge.textContent = 'Pendiente';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      progressLabel.textContent = '';
      visitSummary.hidden = true;
      currentUrlLabel.hidden = true;
      currentUrlLabel.textContent = '';
      jobIdLabel.textContent = '';
      sitesBody.innerHTML = '';
      sitesCount.textContent = '0';
      selectionCount.textContent = '';
      currentContacts = [];
      selectedContactIds = new Set();
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function showAlert(message, variant) {
      alertContainer.innerHTML = `
        <div class="alert alert-${variant} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
      `;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
